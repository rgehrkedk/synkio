/**
 * Synkio Documentation - Interactive Features
 * Generated by Synkio
 */

(function() {
  'use strict';

  // DOM Elements
  const searchInput = document.getElementById('searchInput');
  const themeToggle = document.getElementById('themeToggle');
  const mobileToggle = document.getElementById('mobileToggle');
  const sidebar = document.querySelector('.docs-sidebar');
  const copiedToast = document.getElementById('copiedToast');

  // ============================================
  // Theme Toggle (Light/Dark UI)
  // ============================================

  function initTheme() {
    const savedTheme = localStorage.getItem('synkio-docs-theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
  }

  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('synkio-docs-theme', next);
  }

  if (themeToggle) {
    themeToggle.addEventListener('click', toggleTheme);
  }

  initTheme();

  // ============================================
  // Mode Switcher (Token modes: light/dark/default, etc.)
  // Supports per-collection mode filtering on overview page
  // ============================================

  function initModes() {
    // Get all mode switchers (may be multiple on overview page)
    const modeSwitchers = document.querySelectorAll('.docs-mode-switcher');

    modeSwitchers.forEach(switcher => {
      const collection = switcher.dataset.collection;
      const storageKey = collection
        ? `synkio-docs-mode-${collection}`
        : 'synkio-docs-mode';

      const savedMode = localStorage.getItem(storageKey);
      if (savedMode) {
        // Update button states
        const btns = switcher.querySelectorAll('.docs-mode-btn');
        btns.forEach(btn => {
          if (btn.dataset.mode === savedMode) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        // Apply filtering
        filterByMode(savedMode, collection);
      }
    });
  }

  function setMode(mode, collection) {
    const storageKey = collection
      ? `synkio-docs-mode-${collection}`
      : 'synkio-docs-mode';

    localStorage.setItem(storageKey, mode);

    // Update root data-mode if this is global (no collection)
    if (!collection) {
      document.documentElement.setAttribute('data-mode', mode);
    }

    // Update button states for this switcher
    const selector = collection
      ? `.docs-mode-switcher[data-collection="${collection}"]`
      : '.docs-mode-switcher:not([data-collection])';
    const switcher = document.querySelector(selector);

    if (switcher) {
      const btns = switcher.querySelectorAll('.docs-mode-btn');
      btns.forEach(btn => {
        if (btn.dataset.mode === mode) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Filter tokens by mode
    filterByMode(mode, collection);
  }

  function filterByMode(mode, collection) {
    // Build selector for target elements
    let selector = '[data-token]';
    if (collection) {
      // On overview page, filter only tokens in this collection's section
      selector = `[data-collection="${collection}"] [data-token], [data-token][data-collection="${collection}"]`;
    }

    const tokenElements = document.querySelectorAll(selector);

    tokenElements.forEach(el => {
      const elMode = el.dataset.mode;
      const elCollection = el.dataset.collection || el.closest('[data-collection]')?.dataset.collection;

      // If filtering by collection, only affect that collection's tokens
      if (collection && elCollection !== collection) {
        return;
      }

      if (!elMode || elMode === mode) {
        el.style.display = '';
      } else {
        el.style.display = 'none';
      }
    });

    // Update section visibility
    updateSectionVisibility();
  }

  // Attach click handlers to all mode buttons
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.docs-mode-btn');
    if (btn) {
      const mode = btn.dataset.mode;
      const switcher = btn.closest('.docs-mode-switcher');
      const collection = switcher?.dataset.collection;
      setMode(mode, collection);
    }
  });

  initModes();

  // ============================================
  // Platform Switcher (CSS, iOS, Android, etc.)
  // ============================================

  const platformSelect = document.getElementById('platformSelect');

  function initPlatform() {
    const savedPlatform = localStorage.getItem('synkio-docs-platform');
    const defaultPlatform = document.documentElement.getAttribute('data-platform');

    if (savedPlatform && platformSelect) {
      // Check if saved platform still exists in the select
      const option = platformSelect.querySelector(`option[value="${savedPlatform}"]`);
      if (option) {
        platformSelect.value = savedPlatform;
        document.documentElement.setAttribute('data-platform', savedPlatform);
        filterByPlatform(savedPlatform);
      } else if (defaultPlatform) {
        // Fall back to default platform
        filterByPlatform(defaultPlatform);
      }
    } else if (defaultPlatform) {
      filterByPlatform(defaultPlatform);
    }
  }

  function setPlatform(platform) {
    document.documentElement.setAttribute('data-platform', platform);
    localStorage.setItem('synkio-docs-platform', platform);
    filterByPlatform(platform);
  }

  function filterByPlatform(platform) {
    // Show/hide platform-specific variable names
    const platformVariables = document.querySelectorAll('.docs-token-variable--platform, code.docs-token-variable--platform');
    platformVariables.forEach(el => {
      if (el.dataset.platform === platform) {
        el.style.display = '';
      } else {
        el.style.display = 'none';
      }
    });
  }

  if (platformSelect) {
    platformSelect.addEventListener('change', (e) => {
      setPlatform(e.target.value);
    });
  }

  initPlatform();

  // ============================================
  // Search
  // ============================================

  function debounce(fn, delay) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  function searchTokens(query) {
    const normalizedQuery = query.toLowerCase().trim();
    const tokenElements = document.querySelectorAll('[data-token]');
    const rows = document.querySelectorAll('.docs-token-table tbody tr');

    // Search in card view
    tokenElements.forEach(el => {
      if (!el.matches('tr')) {
        const tokenPath = (el.dataset.token || '').toLowerCase();
        const textContent = el.textContent.toLowerCase();
        const matches = !normalizedQuery || tokenPath.includes(normalizedQuery) || textContent.includes(normalizedQuery);

        // Only show if matches search (mode filter handled separately)
        if (!matches) {
          el.style.display = 'none';
        } else {
          // Re-check mode filter
          const mode = el.dataset.mode;
          const collection = el.dataset.collection || el.closest('[data-collection]')?.dataset.collection;
          const activeMode = getActiveMode(collection);
          if (!mode || mode === activeMode) {
            el.style.display = '';
          }
        }
      }
    });

    // Search in table view
    rows.forEach(row => {
      const tokenPath = (row.dataset.token || '').toLowerCase();
      const textContent = row.textContent.toLowerCase();
      const matches = !normalizedQuery || tokenPath.includes(normalizedQuery) || textContent.includes(normalizedQuery);
      row.style.display = matches ? '' : 'none';
    });

    // Update section visibility
    updateSectionVisibility();
  }

  function getActiveMode(collection) {
    const storageKey = collection
      ? `synkio-docs-mode-${collection}`
      : 'synkio-docs-mode';
    return localStorage.getItem(storageKey) || document.documentElement.getAttribute('data-mode') || 'default';
  }

  function updateSectionVisibility() {
    const sections = document.querySelectorAll('.docs-section');
    sections.forEach(section => {
      const grid = section.querySelector('.docs-token-grid');
      if (grid) {
        const visibleCards = grid.querySelectorAll('.docs-token-card:not([style*="display: none"])');
        section.style.display = visibleCards.length > 0 ? '' : 'none';
      }
    });
  }

  if (searchInput) {
    searchInput.addEventListener('input', debounce((e) => {
      searchTokens(e.target.value);
    }, 150));

    // Clear search on Escape
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchInput.value = '';
        searchTokens('');
      }
    });
  }

  // ============================================
  // Copy to Clipboard
  // ============================================

  function showCopiedToast() {
    copiedToast.classList.add('show');
    setTimeout(() => {
      copiedToast.classList.remove('show');
    }, 2000);
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      showCopiedToast();
    } catch (err) {
      // Fallback for older browsers
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      showCopiedToast();
    }
  }

  // Click to copy on elements with data-copy attribute
  document.addEventListener('click', (e) => {
    const copyable = e.target.closest('[data-copy]');
    if (copyable) {
      e.preventDefault();
      copyToClipboard(copyable.dataset.copy);
    }
  });

  // ============================================
  // Mobile Menu
  // ============================================

  if (mobileToggle && sidebar) {
    mobileToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (sidebar.classList.contains('open') &&
          !sidebar.contains(e.target) &&
          !mobileToggle.contains(e.target)) {
        sidebar.classList.remove('open');
      }
    });
  }

  // ============================================
  // Keyboard Navigation
  // ============================================

  document.addEventListener('keydown', (e) => {
    // Focus search with Cmd/Ctrl + K
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (searchInput) {
        searchInput.focus();
        searchInput.select();
      }
    }
  });

  // ============================================
  // Initialize
  // ============================================

  console.log('Synkio Docs initialized');
})();
